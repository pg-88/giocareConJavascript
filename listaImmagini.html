<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="img/img.jpeg" type="image/x-icon">
    <title>Definitivo Lista Immagini</title>
</head>
<body onload="avvio()">
    
</body>

<script>
    function avvio(){
        /*generazione elementi della pagina, chiamate delle funzioni principali*/
        //genera elementi
        let main = document.createElement("main");
        let title = document.createElement("h1");
        let lbl = document.createElement("label");
        let inputFile = document.createElement("input");
        let listContainer = document.createElement("section");
        let list = document.createElement("ul");

        //collega gli elementi 
        console.log(title, lbl, inputFile, listContainer, list);
        document.body.appendChild(main);
        main.appendChild(title);
        title.after(lbl, inputFile, listContainer, list);
        inputFile.insertAdjacentHTML("afterend",'<br>')

        //completo gli elementi 
        main.id = "principale";
        
        title.id = "titolo";
        title.innerHTML = "Lista di immagini";
        
        lbl.for = "in-file";
        lbl.innerHTML = "Inserisci i files"

        inputFile.id = "in-file";
        inputFile.type = "file";
        inputFile.multiple = true;
        inputFile.accept="image/*"


        //definisco l'event handler gestisciFile che è una funzione ma non devo
        //usare le parentesi per chiamarla, la sto solo collegando all'evento


        inputFile.addEventListener("change", gestisciFile)
        //addEventListner è un metodo degli oggetti html prende il nome dell'evento
        //come stringa e il secondo parametro è il nome della funzione (senza 
        //invocarla). La funzione è definita fuori da questo blocco di codice ma
        //poteva stare qui con la arrow function.

        listContainer.id = "trgt-lst";
        list.id = "lst";

    }

    function gestisciFile(event){

        /*chiamata all'affiorare dell'evento change dell'input file
        di default si porta con sè l'oggetto html che ha generato l'evento
        che può essere richiamato con la parola chiave this*/
/*        console.log("oggetto che ha innescato l'evento: ", this,
            "\ncon la dot notation posso accedere alle proprietà dell'oggetto, this.files:\n",
            this.files,
            "ottengo la lista dei files");

        //con la parola chiave 'event' è possibile chiamare l'evento che si
        //è verificato, da questo posso risalire all'oggetto input file (responsabile
        //dell'evento) con la dot notation event.taget. 
        console.log('passato dall\'evento', event.target);//mettendo un parametro qualsiasi si crea un alias per event

        // this si riferisce all'oggetto a cui è legato il listener;
        // event si riferisce all'evento che è affiorato e porta con se l'oggetto target che ha generato event
        let pic = document.createElement('img');
        document.body.lastElementChild.after(pic);
        pic.src = this.files[0].name; // questo non funziona perché non è possibile avere il percorso file nel sistema
        //proviamo tutte le proprietà per vedere se una può funzionare da src o contiene un path utile
        
        for(let p in this.files[0]){
            if(! pic.complete){
                //se l'immagine non è stata caricata complete è false 
                //se non colpete si cambia src
                console.log('provo: ', p, '\nvalue: ', this.files[0][p]);
                pic.src = this.files[0][p];
                pic.alt += this.files[0][p] +'\n';
            }
        }
        if(! pic.complete) window.alert("nessuna proprietà dell'oggetto files[0] può funzionare come src di img");
*/
        //creo l'lelemento che conterrà le immagini
        const trgtImg = document.createElement('div');
        trgtImg.id = 'trgt-img';
        document.body.lastElementChild.after(trgtImg);//inserisce il target dopo li'ultimo

        let selected = this.files;
        console.log("files: ", selected, "\nFile: ", selected[0]);

        //ciclo tre i files caricati (multiple attr)
        for (let im = 0; im < selected.length; im++){
            //creo elemento html
            const pic = document.createElement('img');
            pic.width = '200';
            trgtImg.appendChild(pic)
            //Per poter passare il file al source di img devo prima digerirlo (leggerlo) e trasformarlo in 
            //url binario
            let imgFile = new FileReader();
            //al caricamento del reader devo gestire il reader per assegnare a src
            //la stringa binaria con l'immagine. Devo farlo qui non posso separare le 
            //fz perché non ho modo di passare il parametro e tornarlo dall'handler
            imgFile.onload = function() {
                pic.src = this.result;
            };
            console.log(selected[im], "tipo",typeof(selected[im]))
            imgFile.readAsDataURL(selected[im]);

            pic.id = selected[im].name;
            pic.alt = selected[im].name; //potrebbe non essere ottimale per l'accessibilità
        }

    }

</script>
</html>